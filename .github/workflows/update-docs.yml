name: Update Schema Docs
on: pull_request

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # When getting Rust dependencies, retry on network error:
  CARGO_NET_RETRY: 10
  # Use the local .curlrc
  CURL_HOME: .

jobs:
  update_all_schema_docs:
    name: schema-docs:required
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check cargo build
        run: cargo build
      - name: Show download worked
        run: cargo run -- --version
      - name: Update any changed schema docs
        run: |
          cargo run -- schema --outfile docs/dfx-json-schema.json
          cargo run -- schema --for networks --outfile docs/networks-json-schema.json
          cargo run -- schema --for dfx-metadata --outfile docs/dfx-metadata-schema.json

          echo "Schema changes:"
          if git diff --exit-code ; then
            echo "(None)"
          else
            echo
            echo "There are code changes to the JSON schema in this PR, but the schema docs have not been updated."
            echo
            echo "Run the above commands locally to update the JSON schema docs."
            exit 1
          fi
